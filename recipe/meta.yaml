{% extends "base.yaml" %}

{% block recipe %}

package:
  name: opencv
  version: {{ opencv_version }}

source:
  fn: opencv-{{ opencv_version }}.tar.gz
  url: https://github.com/opencv/opencv/archive/{{ opencv_version }}.tar.gz
  sha256: b9d62dfffb8130d59d587627703d5f3e6252dce4a94c1955784998da7a39dd35
  patches:
    # Safe mutex unlocking for loopb's KeyThread
    - gtk-safe-mutex-unlock.patch

build:
  number: 1
  skip: true  # [not (linux and np>=111)]
  script_env:
    - WITH_CUDA
  features:
    - gtk2
    - ffmpeg
    - opencv_turbo
    {% if with_cuda == 'ON' %}
    - cuda{{cuda_version}}
    - opencv_cuda
    {% endif %}

requirements:
  build:
    - python
    - toolchain
    # For sha256 comparisons of opencv_contrib
    - openssl 1.0.*         # [unix]
    # For downloading opencv_contrib
    - curl
    - cmake
    - numpy x.x
    - hdf5 1.8.17|1.8.17.*  # [unix]
    - eigen 3.2.*
    - jasper                # [unix]
    - zlib 1.2.*
    - libjpeg-turbo
    - libtiff 4.0.*
    - libwebp 0.5.*
    - harfbuzz 1.4.*        # [unix]
    - libpng >=1.6.28,<1.7
    - ffmpeg
    - gtk2

  run:
    - python
    - numpy x.x
    - hdf5 1.8.17|1.8.17.*  # [unix]
    - jasper                # [unix]
    - zlib 1.2.*
    - libjpeg-turbo
    - libwebp 0.5.*
    - harfbuzz 1.4.*        # [unix]
    - libtiff 4.0.*
    - libpng >=1.6.28,<1.7

test:
  requires:
    - gtk2
    - ffmpeg-feature
    - opencv-turbo-feature {{ opencv_version }}
    {% if with_cuda == 'ON' %}
    - cuda-feature {{ cuda_version }}
    - opencv-cuda-feature {{ cuda_version }}
    {% endif %}

  imports:
    - cv2
    - cv2.xfeatures2d

  commands:
    # Verify dynamic libraries on all systems
    {% set opencv_libs = [
      "aruco",
      "bgsegm",
      "calib3d",
      "ccalib",
      "core",
      "datasets",
      "dnn",
      "dpm",
      "face",
      "features2d",
      "flann",
      "fuzzy",
      "highgui",
      "imgcodecs",
      "imgproc",
      "line_descriptor",
      "ml",
      "objdetect",
      "optflow",
      "phase_unwrapping",
      "photo",
      "plot",
      "reg",
      "rgbd",
      "saliency",
      "shape",
      "stereo",
      "stitching",
      "structured_light",
      "superres",
      "surface_matching",
      "text",
      "tracking",
      "video",
      "videoio",
      "videostab",
      "xfeatures2d",
      "ximgproc",
      "xobjdetect",
      "xphoto"
    ] %}
    {% for each_opencv_lib in opencv_libs %}
    - test -f $PREFIX/lib/libopencv_{{ each_opencv_lib }}.dylib                        # [osx]
    - test -f $PREFIX/lib/libopencv_{{ each_opencv_lib }}.so                           # [linux]
    - if not exist %PREFIX%\\Library\\bin\\opencv_{{ each_opencv_lib }}320.dll exit 1  # [win]
    {% endfor %}
    - test -f $PREFIX/lib/libopencv_bioinspired.dylib  # [osx]
    - test -f $PREFIX/lib/libopencv_bioinspired.so     # [linux]
    - test -f $PREFIX/lib/libopencv_hdf.dylib          # [osx]
    - test -f $PREFIX/lib/libopencv_hdf.so             # [linux]
    - test -f $PREFIX/lib/libopencv_freetype.dylib     # [osx]
    - test -f $PREFIX/lib/libopencv_freetype.so        # [linux]

{% endblock %}

# TODO: complete tests with CUDA artefacts, use harder tests
